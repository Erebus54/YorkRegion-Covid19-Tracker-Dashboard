---
title: "York Region Tracker"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: ["twitter", "facebook", "linkedin"]
    theme: cosmo
runtime: shiny
---
<style>
.navbar {
  background-color:black;
  border-color:white;
}

.navbar-brand {color:white!important;}

.navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    background-color: #04d9ff;
    color: white;
}
.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: white;
  background-color: #04d9ff;
}
.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  background-color: #04d9ff;
}
.navbar-inverse .navbar-collapse,
.navbar-inverse .navbar-form {
  border-color: #04d9ff;
}
</style>


```{r setup, include=FALSE}
library(flexdashboard)
library(rsconnect)

library(dplyr)
library(tidyverse)

library(lubridate)
library(zoo)
library(data.table)

library(plotly)

casestatus <- fread("./datasets/casestatus.csv", encoding = 'UTF-8',data.table = F)

casestatus$Reporting_PHU <- trimws(casestatus$Reporting_PHU)
casestatus$Case_AcquisitionInfo <- trimws(casestatus$Case_AcquisitionInfo)

#converting dates into proper formats 
casestatus$Accurate_Episode_Date <- as.Date(casestatus$Accurate_Episode_Date, format = "%Y-%m-%d")
casestatus$Case_Reported_Date <- as.Date(casestatus$Case_Reported_Date, format = "%Y-%m-%d")
casestatus$Test_Reported_Date <- as.Date(casestatus$Test_Reported_Date, format = "%Y-%m-%d")

TargetPHU <- casestatus 
```

```{r}
##adding a range selector variable to supply list of options for our time series graphs into buttons_time
buttons_time <- list(
  list(step = "all"), 
  
  list(
    count = 6,
    label = "6 mo",
    step = "month",
    stepmode = "backward"),
  
  list(
    count = 3, 
    label = "3 mo", 
    step = "month", 
    stepmode = "backward"), 
  
  list(
    count = 2, 
    label = "2 mo", 
    step = "month", 
    stepmode = "backward"), 
  
  list(
    count = 1,
    label = "1 mo",
    step = "month",
    stepmode = "backward"),
  
  list(
    count = 14,
    label = "2W",
    step = "day",
    stepmode = "backward")

)
```



Home
=====================================

Row
-----------------------------------------------------------------------
### Total Cumulative Cases 
```{r}

#use this to change icons https://ionicons.com/v2/cheatsheet.html
cCases <- paste(format(round(as.numeric(nrow(TargetPHU)), 0), nsmall=0, big.mark=",")  # 1,000.6
)
valueBox(cCases, icon = "ion-android-person-add")
```

### New Cases 
```{r}
todays_cases <- TargetPHU %>% 
  dplyr::filter(Accurate_Episode_Date == max(Accurate_Episode_Date)) %>% 
  dplyr::count()

valueBox(paste("+", todays_cases, sep = ""), icon = "ion-stats-bars")
```


### Rate per 100K Population 
```{r}

# src: https://www12.statcan.gc.ca/census-recensement/2016/dp-pd/prof/details/page.cfm?Lang=E&Geo1=CD&Code1=3519&Geo2=PR&Code2=35&SearchText=York&SearchType=Begins&SearchPR=01&B1=All&GeoLevel=PR&GeoCode=3519&TABID=1&type=0

POP <- 1109909
existingCases <- nrow(TargetPHU)
prevalence <- existingCases/POP
prevalencerate <- as.integer(prevalence*100000)

valueBox(prevalencerate, icon = "ion-stats-bars")
```


### Close Contact Related Cases

```{r}
closecontactValue <- TargetPHU %>% 
  dplyr::filter(Case_AcquisitionInfo == "CC") 

valueBox(format(round(as.numeric(nrow(closecontactValue)), 0), nsmall=0, big.mark=","), icon = "ion-ios-people")
```


### Outbreak Related Cases
```{r}
obValue <- TargetPHU %>% 
  dplyr::filter(Case_AcquisitionInfo == "OB") 

valueBox(format(round(as.numeric(nrow(obValue)), 0), nsmall=0, big.mark=","), icon = "ion-alert-circled")
```

### Travel Related Cases
```{r}
travelCases <- TargetPHU %>% 
  dplyr::filter(Case_AcquisitionInfo == "Travel") 

valueBox(nrow(travelCases), icon = "ion-plane")
```

### Population Infected 
```{r}
valueBox(paste(round(as.integer(nrow(TargetPHU))/POP*100,2), "%"), icon = "ion-ios-calculator")
```


Row {.tabset .tabset-fade}
-------------------------------------

```{r}
#calculating the growth absolute and relative change in cases
dailyPHU <- data.frame(TargetPHU %>% 
  dplyr::arrange(Accurate_Episode_Date) %>% 
  dplyr::group_by(Accurate_Episode_Date) %>% 
  dplyr::count(name = "Cases") %>% 
  dplyr::ungroup()
)

dailyPHU <- dailyPHU %>% 
  dplyr::mutate(d_diff = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date)),
                csum = cumsum(Cases),
                diff_growth = Cases - lag(Cases), 
                growth_rate_pct = round((diff_growth/d_diff)/Cases * 100, 2)
  )

#calculating rolling average 
rolling.avg <- dailyPHU %>% 
  dplyr::select(Accurate_Episode_Date, Cases) %>% 
  dplyr::mutate(cp.7 = round(zoo::rollmean(Cases, k = 7, fill = NA),0),
                cp.14 = round(zoo::rollmean(Cases, k = 14, fill = NA),0), 
                cp.28 = round(zoo::rollmean(Cases, k = 28, fill = NA),0), 
                cp.56 = round(zoo::rollmean(Cases, k = 56, fill = NA),0)
)
```


### <b> Daily Cases </b> 
```{r}
# date <- c("2020-03-23", "2020-07-24", "2020-10-19")
# status <- c("State of Emergency Declared", "Stage 3 Reopening", "Stage 2")
# 
# timeline <- data.frame(date, status)
# timeline$date <- as.Date(timeline$date, format = "%Y-%m-%d")
# 
# a <- list(
#   x = timeline$date,
#   y = 50,
#   text = timeline$status,
#   xref = "x",
#   yref = "y",
#   font = list(color = "Black",
#               size = 12), 
#   showarrow = TRUE,
#   arrowcolor = "Black",
#   arrowsize = 2,
#   arrowwidth = 1,
#   arrowhead = 2,
#   ax = 0,
#   ay = -50
# )


plot_ly(data = dailyPHU, 
        x = ~Accurate_Episode_Date, 
        y= ~Cases, 
        type = 'bar', name = 'Confirmed Positive',
        marker = list(color = '#2858a6'), 
        showlegend = F, 
        
        hoverinfo = 'text', 
        text = ~paste(Accurate_Episode_Date, "<br>", 
                      Cases, ' New Cases', sep = "")
        
        ) %>% 

  
  layout(title = "",
         yaxis = list(title = '<b>New Cases </b>'),
         xaxis = list(title = ' ', 
                      rangeselector = list(buttons = buttons_time)),
         hovermode = "x unified", 
         
         hoverlabel=list(bgcolor="black"), 
         
         paper_bgcolor='transparent')
```


### <b> The Curve - Linear Scale </b>

```{r}
fig <- plot_ly(x = ~dailyPHU$Accurate_Episode_Date, y = ~dailyPHU$csum, type = 'scatter', mode = 'none', name = 'Total Cases', fill = 'tozeroy',
               fillcolor = '#2858a6')

fig <- fig %>% layout(xaxis = list(title = '', 
                                   rangeselector = list(buttons = buttons_time)),
                      yaxis = list(title = 'Cumulative Case'), 
                      hovermode = "x unified", 
                      hoverlabel=list(bgcolor="black"), 
                      
                      paper_bgcolor='transparent')
fig 
```

### <b> The Curve - Logarithmic Scale </b>

```{r}
fig <- fig %>% layout(yaxis = list(type = "log"))
fig <- fig %>% layout(xaxis = list(title = ""),
                      yaxis = list (title = "Cumulative Case Counts (Log)"))
fig
```

### <b> Rolling Averages </b>

```{r}
plot_ly(rolling.avg, x = ~Accurate_Episode_Date, y = ~cp.7, name = "7 Day Average",
        type = 'scatter', mode = 'lines', fill = 'tozeroy', line = list(width = 0.1)) %>% 
  
  add_trace(y = ~cp.14, name = "14 Day Average") %>% 
  add_trace(y = ~cp.28, name = "28 Day Average ") %>% 
  
  layout(title = "",
         xaxis = list(title = ""), 
         yaxis = list(title = "New Cases"), 
         hovermode = "x unified") %>% 
  
    layout(xaxis = list(rangeselector = list(
    buttons = buttons_time
  )))
```

### <b> Rolling Median </b>

```{r}
rolling.avg <- dailyPHU %>% 
  dplyr::select(Accurate_Episode_Date, Cases) %>% 
  dplyr::mutate(cp.7 = round(zoo::rollmedian(Cases, k = 7, fill = NA),0),
                cp.14 = round(zoo::rollmedian(Cases, k = 14, fill = NA),0), 
                cp.28 = round(zoo::rollmedian(Cases, k = 28, fill = NA),0)
)

plot_ly(rolling.avg, x = ~Accurate_Episode_Date, y = ~cp.7, name = "7 Day Median Trend",
        type = 'scatter', mode = 'lines', fill = 'tozeroy', line = list(width = 0.1)) %>% 
  
  add_trace(y = ~cp.14, name = "14 Day Median Trend") %>% 
  add_trace(y = ~cp.28, name = "28 Day Median Trend") %>% 

  layout(title = "",
         xaxis = list(title = " "), 
         yaxis = list(title = "New Cases"), 
         hovermode = "x unified") %>% 
  
    layout(xaxis = list(rangeselector = list(
    buttons = buttons_time
  )))
  
```

Outcomes 
=====================================

```{r}
outcomes <- TargetPHU %>% 
  dplyr::select(Row_ID,Accurate_Episode_Date, Outcome1) %>% 
  group_by(Accurate_Episode_Date, Outcome1) %>% 
  summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  spread(Outcome1, count, fill = 0) %>% 
  as.data.frame()

outcomes <- outcomes %>% 
  dplyr::rename(Unresolved = 3)
```


Row
-----------------------------------------------------------------------
### Current Active Cases 

```{r}
valueBox(format(round(as.numeric(sum(outcomes$Unresolved)), 0), nsmall=0, big.mark=","), icon = "ion-android-person-add")
```

### Total Resolved 

```{r}
valueBox(format(round(as.numeric(sum(outcomes$Resolved)), 0), nsmall=0, big.mark=","), icon = "ion-android-person-add")
```

### Current Recovery Rate 

```{r}
rr <- paste(round(100-(sum(outcomes$Fatal)/sum(outcomes$Resolved, outcomes$Unresolved, outcomes$Fatal) * 100),0), "%")
valueBox(rr, icon = "ion-ios-calculator")
```

### Total Deaths 
```{r}
valueBox(format(round(as.numeric(sum(outcomes$Fatal)), 0), nsmall=0, big.mark=","), icon = "ion-android-person-add")
```

### Death Rate per 100K Population 
```{r}
fatality <- sum(outcomes$Fatal/POP)
fatality_rate_per_capita_K <- as.integer(fatality*100000)

valueBox(fatality_rate_per_capita_K, icon = "ion-stats-bars")
```

Row {.tabset .tabset-fade}
-------------------------------------
### <b> Outcome Breakdown </b> 
```{r}
outcomeBreakdown <- TargetPHU %>% 
  dplyr::group_by(Outcome1) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>%
  dplyr::ungroup() %>% 
  data.frame()

colors <- c('#FF5959', "#FFC56C", "#6EC5E9")

fig <- plot_ly(outcomeBreakdown, labels = ~Outcome1, values = ~n, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste(n, ' cases'),
        
        marker = list(colors = colors,
                      line = list(color = '#FFFFFF', width = 1)),
        #The 'pull' attribute can also be used to create space between the sectors
        showlegend = FALSE)

fig <- fig %>% layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


### <b> Daily Outcomes </b> 
```{r}
#Cases by Outcome 
fig <- plot_ly(x = ~outcomes$Accurate_Episode_Date, y = ~outcomes$Unresolved, type = 'bar', name = 'Active', 
               marker = list(color = '#FFC56C'))

fig <- fig %>% add_trace(x = ~outcomes$Accurate_Episode_Date, y = ~outcomes$Resolved, name = 'Resolved', 
                         marker = list(color = '#6EC5E9'))

fig <- fig %>% add_trace(x = ~outcomes$Accurate_Episode_Date, y = ~outcomes$Fatal, name = 'Deaths', 
                         marker = list(color ='#FF5959'))

fig <- fig %>% layout(title = "", 
                      xaxis = list(title = ''),
                      yaxis = list(title = 'Cumulative Case Counts'), 
                      hovermode = "x unified",
                      barmode = 'stack')

fig <- fig %>%   layout(xaxis = list(rangeselector = list(
    buttons = buttons_time
  )))
  

fig 
```

### <b> Absolute Change </b>
```{r}
outcomes_changes <- outcomes %>% 
  dplyr::mutate(d_diff = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date)),
                total_deaths = cumsum(Fatal), 
                total_unresolved = cumsum(Unresolved), 
                total_resolved = cumsum(Resolved),
                
                new_deaths = Fatal - lag(Fatal), 
                new_resolved = Resolved - lag(Resolved), 
                
                new_deathsPct = round((Fatal / lag(Fatal) - 1)* 100,2),
                new_resolvedPct = round((Resolved / lag(Resolved) - 1)* 100,2))


plot_ly(data = outcomes_changes, x = ~Accurate_Episode_Date, y = ~new_resolved, 
               type = 'scatter',
               mode = "lines", 
               name = "New Recoveries", 
               line = list(color = "#25D366", width = 1)) %>% 
  
  add_trace(y = ~new_deaths, 
            name = "New Deaths", 
            line = list(color = "#FF5959", width = 1)) %>% 
  layout(title = "", 
         xaxis = list(title = '', rangeselector = list(buttons = buttons_time)),
         yaxis = list(title = 'Absolute Change in Cases'), 
         hovermode = "x unified",
         barmode = 'stack') 
```

### <b> Cumulative </b> 

```{r}
fig <- plot_ly(x = ~outcomes_changes$Accurate_Episode_Date, y = ~outcomes_changes$total_resolved, type = 'bar', name = 'Resolved', 
               marker = list(color = '#25D366'))

fig <- fig %>% add_trace(x = ~outcomes_changes$Accurate_Episode_Date, y = ~outcomes_changes$total_deaths, name = 'Deaths', 
                         marker = list(color ='#FF5959'))

fig <- fig %>% layout(title = "", 
                      xaxis = list(title = ''),
                      yaxis = list(title = 'Cumulative Case Counts'), 
                      hovermode = "x unified",
                      barmode = 'stack') %>% 
  
  layout(xaxis = list(rangeselector = list(
    buttons = buttons_time)))

fig
```





Case Acquisition
=====================================

```{r}
acqBreakdown <- TargetPHU %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  dplyr::group_by(Case_AcquisitionInfo) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame()

acqBreakdown$colors <- c("#E01E5A", "#F4B400", "#25D366", "#C0C0C0")
```


Row
-----------------------------------------------------------------------

### Travel Related Cases 
```{r}
valueBox(paste(round(sum(TargetPHU$Case_AcquisitionInfo == "Travel")/nrow(TargetPHU)*100, 1), "%"), icon = "ion-plane")
```

### Close Contact Cases 
```{r}
valueBox(paste(round(sum(TargetPHU$Case_AcquisitionInfo == "CC")/nrow(TargetPHU)*100, 1), "%"), icon = "ion-ios-people")
```

### Outbreak Related Cases 
```{r}
valueBox(paste(round(sum(TargetPHU$Case_AcquisitionInfo == "OB")/nrow(TargetPHU)*100, 1), "%"), icon = "ion-alert-circled")
```


Row {.tabset .tabset-fade}
-------------------------------------

### <b> Breakdown </b> 
```{r}
fig <- plot_ly(acqBreakdown, labels = ~Case_AcquisitionInfo, values = ~n, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        #text = ~paste(n, ' cases'),
        text = ~paste(Case_AcquisitionInfo, '<br>', 
                     format(n, nsmall = 0, big.mark = ","), ' cases', sep = ""),
        
        marker = list(colors = ~colors,
                      line = list(color = '#FFFFFF', width = 1)),
        #The 'pull' attribute can also be used to create space between the sectors
        showlegend = FALSE)

fig <- fig %>% layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
``` 

### <b> Case Acquisitions over time </b> 

```{r}
acq_daily <- TargetPHU %>% 
  dplyr::select(Row_ID, Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>%
  group_by(Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  summarise(count = n(), .groups = 'keep') %>%
  dplyr::ungroup() %>% 
  spread(Case_AcquisitionInfo, count, fill = 0) %>% 
  as.data.frame()

plot_ly(data = acq_daily, 
        x = ~Accurate_Episode_Date, 
        y = ~`Close Contact`, type = 'bar', 
        name = 'Close Contact', 
        marker = list(color = '#E01E5A')) %>% 
  
  add_trace(y = ~`Outbreak Related`, name = 'Outbreak Related', marker = list(color = '#F4B400')) %>% 
  
  add_trace(y = ~Travel, name = 'Travel', marker = list(color ='#25D366'))%>% 
  
  add_trace(y = ~Unknown, 
            name = "Unknown", marker = list(color = "#DCDCDC")) %>% 

  layout(title = "", 
         xaxis = list(title = '', 
                      rangeselector = list(buttons = buttons_time)),
         yaxis = list(title = 'Daily Cases'), 
         hovermode = "x unified",
         barmode = 'stack') 
```



### <b> Cumulative Acquisitions </b> 
```{r cumacq}
acq_daily <- TargetPHU %>% 
  dplyr::select(Row_ID,Case_Reported_Date, Case_AcquisitionInfo) %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  dplyr::group_by(Case_Reported_Date, Case_AcquisitionInfo) %>% 
  dplyr::summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  tidyr::spread(Case_AcquisitionInfo, count, fill = 0) %>% 
  as.data.frame() %>% 
  
  #adding cumulative counts 
  dplyr::mutate(CC_csum = cumsum(`Close Contact`), 
                OB_csum = cumsum(`Outbreak Related`), 
                Travel_csum = cumsum(Travel),
                Unknown_csum = cumsum(`Unknown`)) 
acq_daily <- na.omit(acq_daily, cols = "Case_Reported_Date")
plot_ly(acq_daily, x = ~Case_Reported_Date, y = ~OB_csum, 
        type = 'scatter', mode = 'none', fill = 'tozeroy', 
        name = 'Outbreak', 
        fillcolor = 'rgba(244, 180, 0, 0.7)',
        opacity = 0.8) %>% 
  
  add_trace(x = ~Case_Reported_Date,y = ~CC_csum, name = "Close Contact", 
            fill = 'tozeroy',
            fillcolor = 'rgba(224, 30, 90, 0.7)',
            opacity = 0.8) %>% 
  
  add_trace(x = ~Case_Reported_Date,y = ~Travel_csum, name = "Travel", 
            fill = 'tozeroy',
            fillcolor = 'rgba(37, 211, 102, 0.7)',
            opacity = 0.8) %>% 
  
  add_trace(x = ~Case_Reported_Date,y = ~Unknown_csum, name = "Uknown", 
            fill = 'tozeroy',
            fillcolor = 'rgba(220, 220, 220, 0.7)',
            opacity = 0.8) %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Cumulative Totals"))
```

### <b> Heatmaps </b> 

```{r}
acq_daily <- TargetPHU %>% 
  dplyr::select(Row_ID, Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  group_by(Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  as.data.frame()

acq_daily$Case_AcquisitionInfo <- factor(acq_daily$Case_AcquisitionInfo, 
                                      levels = unique(acq_daily$Case_AcquisitionInfo)[order(acq_daily$count, decreasing = FALSE)])

plot_ly(data = acq_daily, 
        x = ~Accurate_Episode_Date, 
        y = ~Case_AcquisitionInfo, 
        z = ~count, 
        type = "heatmap",
        #colors = colorRamp(c("Black","Blue", "Red")),
        text = ~paste(acq_daily$Case_AcquisitionInfo, "<br>", 
                       acq_daily$Accurate_Episode_Date,
                       "<br>", acq_daily$count, " cases",
                       sep = ""), 
        hoverinfo = "text", 
        
        showlegend = F, 
        showscale = FALSE) %>% 
  
  layout(title = "", 
         
         xaxis = list(title = "", rangeselector = list(
           buttons = buttons_time)),
         yaxis = list(title = ""),
         
         barmode = 'stack', 
         hovermode = 'x-unified', 
         hoverlabel=list(bgcolor="black"), 
         plot_bgcolor='Black',
         paper_bgcolor='Black', 
         font = list(color = 'Grey')) 
```


Demographics
=====================================

```{r}
ages <- TargetPHU %>% 
  dplyr::group_by(Age_Group) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame()

#breakdown by gender 
genders <- TargetPHU %>% 
  dplyr::group_by(Client_Gender) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame() 
```

Row {.tabset .tabset-fade}
-------------------------------------

### <b> Age Breakdown Pie </b> 
```{r}
ages$Age_Group <- ordered(ages$Age_Group, levels = c("<20", "20s", "30s", "40s", "50s", "60s", "70s", "80s", "90s"))

plot_ly(ages, 
        labels = ~Age_Group, 
        values = ~n, 
        type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste(format(n, nsmall = 0, big.mark = ","), ' Cases'),
               
        marker = list(colors = ~colors,
                      line = list(color = '#FFFFFF', width = 1)),
        showlegend = FALSE) %>% 
  
  layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

### <b> Age Breakdown Treemap </b> 
```{r}
fig <- plot_ly(data = ages, 
        labels = ~Age_Group, 
        parents = NA, 
        values = ~n, 
        type = 'treemap', 
        domain = list(column=0), 
        marker = list(colorscale = 'Rainbow', reversescale = T),
        textposition = 'inside',
        textinfo = 'label',
        insidetextfont = list(color = '#FFFFFF', size = 20),
        hoverinfo = 'text',
        text = ~paste(Age_Group,':', n, 'Total Cases')) 

fig <- fig %>% 
  
  layout(plot_bgcolor = 'black', 
         paper_bgcolor = 'black', 
         grid = list(columns = 1, rows = 1))

fig
```

### <b> Daily Cases by Age </b>

```{r}
daily_ages <- TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::group_by(Accurate_Episode_Date, Age_Group) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  data.frame()

daily_ages$Age_Group <- ordered(daily_ages$Age_Group, levels = c("<20", "20s", "30s", "40s", "50s", "60s", "70s", "80s", "90s"))

daily_ages <- daily_ages %>% 
  dplyr::arrange(Accurate_Episode_Date, Age_Group)



plot_ly(daily_ages, 
        x = ~Accurate_Episode_Date, 
        y = ~n, 
        type = 'bar', 
        color = ~Age_Group, 
        colors = "Paired") %>% 
  
  layout(barmode = "stack", 
         hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "Cases")) %>% 
  
  layout(xaxis = list(rangeselector = list(
    buttons = buttons_time)))
```

### <b> Cumulative Cases by Age Group </b>
```{r csumbyAge}
daily_ages <- daily_ages %>% 
  dplyr::group_by(Age_Group) %>%
  dplyr::mutate(csum = cumsum(n)) %>% 
  dplyr::ungroup() %>% 
  data.frame()

plot_ly(daily_ages, x = ~Accurate_Episode_Date, y = ~csum, 
        type = 'scatter', mode = 'lines', fill = 'tozeroy', 
        color = ~Age_Group, 
        colors = "Paired") %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "Cases")) %>% 
  
  layout(xaxis = list(rangeselector = list(
    buttons = buttons_time)))
```


### <b> Gender Breakdown </b>
```{r}
colors <- c('#c37ef0', "#54c3ff")

fig <- plot_ly(genders, labels = ~Client_Gender, values = ~n, type = 'pie',
               textposition = 'inside',
               textinfo = 'label+percent',
               insidetextfont = list(color = '#FFFFFF'),
               hoverinfo = 'text',
               text = ~paste(format(n, nsmall = 0, big.mark = ","), ' cases'),
               
               marker = list(colors = ~colors,
                             line = list(color = '#FFFFFF', width = 1)),
               #The 'pull' attribute can also be used to create space between the sectors
               showlegend = FALSE)

fig <- fig %>% layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

### <b> Daily Cases by Gender </b>
```{r}
#daily cases by gender 
daily_genders <- TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::filter(Client_Gender %in% c("MALE", "FEMALE")) %>% 
  dplyr::group_by(Accurate_Episode_Date, Client_Gender) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(HEX = case_when(Client_Gender == "MALE" ~ '#54c3ff', 
                                Client_Gender == "FEMALE" ~ '#c37ef0')) %>%
  dplyr::mutate(HEX = as.character(HEX)) %>% 
  dplyr::arrange(desc(Accurate_Episode_Date)) %>% 
  data.frame()

plot_ly(data = daily_genders, 
        x = ~Accurate_Episode_Date, 
        y = ~n, 
        type = 'bar', 
        color = ~Client_Gender, 
        colors = ~HEX) %>% 
  
  layout(barmode = "stack", 
         hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "New Cases")) 

```

### <b> Cumulative Cases by Gender </b> 
```{r}
daily_genders_cum <- daily_genders %>% 
  dplyr::filter(!Accurate_Episode_Date == "2019-12-25") %>% 
  dplyr::arrange(Accurate_Episode_Date)%>% 
  dplyr::group_by(Client_Gender) %>% 
  dplyr::mutate(Total = cumsum(n)) %>% 
  dplyr::mutate(HEX = as.character(HEX)) %>%
  dplyr::ungroup() %>% 
  data.frame()


males <- daily_genders_cum[which(daily_genders_cum$Client_Gender == "MALE"), ]
females <- daily_genders_cum[which(daily_genders_cum$Client_Gender == "FEMALE"), ]

plot_ly(females, x = ~Accurate_Episode_Date,  y = ~Total,  type = 'scatter', mode = 'none', name = 'FEMALE', fill = 'tozeroy', 
        fillcolor = "#c37ef0",
        opacity = 0.5) %>% 
  
  add_trace(data = males, x = ~Accurate_Episode_Date, y = ~Total, name = "MALE",
            fillcolor = "#54c3ff") %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "Total Cases")) %>% 
  
  layout(xaxis = list(rangeselector = list(
    buttons = buttons_time)))
```




About this Site
===================================== 

#### <b> Last Update: `r paste(format(Sys.time(), "%Y-%m-%d"))` </b>   

</br>

#### <b> Background </b>
*"Nothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less" - Marie Curie*  

#### <b> Code </b>
Codebase and dataset used to generate this web application are available on [Github](https://github.com/Erebus54/YorkRegion-Covid19-Tracker-Dashboard).


#### <b> Sources </b> 

**Status of COVID-19 cases in Ontario** : [Open Data Ontario](https://data.ontario.ca/en/dataset/confirmed-positive-cases-of-covid-19-in-ontario), updated daily, which presents a breakdown by region, case status, age range of cases 

#### <b> Author </b> 

Patrick Schnurbusch

#### <b> Contact </b> 

patrick.schnurbusch@gmail.com
