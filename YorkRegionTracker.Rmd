---
title: "York Region Tracker"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: cosmo
runtime: shiny
---
<style>
.navbar {
  background-color:black;
  border-color:white;
}

.navbar-brand {color:white!important;}

.navbar-inverse .navbar-nav > li > a:hover,
.navbar-inverse .navbar-nav > li > a:focus {
    background-color: #04d9ff;
    color: white;
}
.navbar-inverse .navbar-nav > .active > a,
.navbar-inverse .navbar-nav > .active > a:hover,
.navbar-inverse .navbar-nav > .active > a:focus {
  color: white;
  background-color: #04d9ff;
}
.navbar-inverse .navbar-toggle:hover,
.navbar-inverse .navbar-toggle:focus {
  background-color: #04d9ff;
}
.navbar-inverse .navbar-collapse,
.navbar-inverse .navbar-form {
  border-color: #04d9ff;
}
</style>


```{r setup, include=FALSE}
library(flexdashboard)
library(rsconnect)

library(dplyr)
library(tidyverse)

library(lubridate)
library(zoo)
library(data.table)

library(plotly)

casestatus <- fread("./datasets/casestatus.csv", encoding = 'UTF-8',data.table = F)

casestatus$Reporting_PHU <- trimws(casestatus$Reporting_PHU)
casestatus$Case_AcquisitionInfo <- trimws(casestatus$Case_AcquisitionInfo)

#converting dates into proper formats 
casestatus$Accurate_Episode_Date <- as.Date(casestatus$Accurate_Episode_Date, format = "%Y-%m-%d")
casestatus$Case_Reported_Date <- as.Date(casestatus$Case_Reported_Date, format = "%Y-%m-%d")
casestatus$Test_Reported_Date <- as.Date(casestatus$Test_Reported_Date, format = "%Y-%m-%d")

TargetPHU <- casestatus 
```

```{r}
##adding a range selector variable to supply list of options for our time series graphs into buttons_time
buttons_time <- list(
  list(step = "all"), 
  
  list(
    count = 6,
    label = "6 mo",
    step = "month",
    stepmode = "backward"),
  
  list(
    count = 3, 
    label = "3 mo", 
    step = "month", 
    stepmode = "backward"), 
  
  list(
    count = 2, 
    label = "2 mo", 
    step = "month", 
    stepmode = "backward"), 
  
  list(
    count = 1,
    label = "1 mo",
    step = "month",
    stepmode = "backward"),
  
  list(
    count = 14,
    label = "2W",
    step = "day",
    stepmode = "backward")

)
```



Home
=====================================

Row
-----------------------------------------------------------------------
### Total Cumulative Cases 
```{r}

#use this to change icons https://ionicons.com/v2/cheatsheet.html
cCases <- paste(format(round(as.numeric(nrow(TargetPHU)), 0), nsmall=0, big.mark=",")  # 1,000.6
)
valueBox(cCases, icon = "ion-ios-people")
```

### New Cases 
```{r}
todays_cases <- TargetPHU %>% 
  dplyr::filter(Accurate_Episode_Date == max(Accurate_Episode_Date)) %>% 
  dplyr::count()

valueBox(paste("+", todays_cases, sep = ""), icon = "ion-android-person-add")
```


### Rate per 100K Population 
```{r}

# src: https://www12.statcan.gc.ca/census-recensement/2016/dp-pd/prof/details/page.cfm?Lang=E&Geo1=CD&Code1=3519&Geo2=PR&Code2=35&SearchText=York&SearchType=Begins&SearchPR=01&B1=All&GeoLevel=PR&GeoCode=3519&TABID=1&type=0

POP <- 1109909
existingCases <- nrow(TargetPHU)
prevalence <- existingCases/POP
prevalencerate <- as.integer(prevalence*100000)

valueBox(format(prevalencerate, big.mark = ","), icon = "ion-stats-bars")
```


### Close Contact Related Cases

```{r}
closecontactValue <- TargetPHU %>% 
  dplyr::filter(Case_AcquisitionInfo == "CC") 

valueBox(format(round(as.numeric(nrow(closecontactValue)), 0), nsmall=0, big.mark=","), icon = "ion-ios-people")
```


### Outbreak Related Cases
```{r}
obValue <- TargetPHU %>% 
  dplyr::filter(Case_AcquisitionInfo == "OB") 

valueBox(format(round(as.numeric(nrow(obValue)), 0), nsmall=0, big.mark=","), icon = "ion-alert-circled")
```

### Travel Related Cases
```{r}
travelCases <- TargetPHU %>% 
  dplyr::filter(Case_AcquisitionInfo == "Travel") 

valueBox(nrow(travelCases), icon = "ion-plane")
```

### Population Infected 
```{r}
valueBox(paste(round(as.integer(nrow(TargetPHU))/POP*100,2), "%"), icon = "ion-ios-calculator")
```


Row {.tabset .tabset-fade}
-------------------------------------

```{r}
#calculating the growth absolute and relative change in cases
dailyPHU <- data.frame(TargetPHU %>% 
  dplyr::arrange(Accurate_Episode_Date) %>% 
  dplyr::group_by(Accurate_Episode_Date) %>% 
  dplyr::count(name = "Cases") %>% 
  dplyr::ungroup()
)

dailyPHU <- dailyPHU %>% 
  dplyr::mutate(d_diff = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date)),
                csum = cumsum(Cases),
                diff_growth = Cases - lag(Cases), 
                growth_rate_pct = round((diff_growth/d_diff)/Cases * 100, 2)
  )

```


### <b> Daily Cases </b> 
```{r}
TargetPHU %>% 
  dplyr::select(Accurate_Episode_Date) %>% 
  dplyr::arrange(Accurate_Episode_Date) %>% 
  dplyr::group_by(Accurate_Episode_Date) %>% 
  dplyr::count(name = "Cases") %>% 
  dplyr::ungroup() %>% 

plot_ly(x = ~Accurate_Episode_Date, 
        y= ~Cases, 
        type = 'bar', name = 'Confirmed Positive',
        marker = list(color = '#2858a6'), 
        showlegend = F, 
        
        hoverinfo = 'text', 
        text = ~paste(Accurate_Episode_Date, "<br>", 
                      format(Cases, big.mark = ","), ' New Cases', sep = "")) %>% 
  
  layout(title = "",
         yaxis = list(title = 'New Cases (n)'),
         xaxis = list(title = ' ', 
                      rangeselector = list(buttons = buttons_time)),
         hovermode = "x unified", 
         
         hoverlabel=list(bgcolor="#2858a6"), 
         
         paper_bgcolor='transparent')
```


### <b> The Curve - Linear Scale </b>

```{r}

fig <- plot_ly(x = ~dailyPHU$Accurate_Episode_Date, 
               y = ~dailyPHU$csum, 
               type = 'scatter', mode = 'none', 
               name = 'Total Cases', fill = 'tozeroy',
               fillcolor = '#2858a6', 
               hoverinfo = 'text', 
               text = ~paste(dailyPHU$Accurate_Episode_Date, "<br>", 
                      format(dailyPHU$csum, big.mark = ","), ' Total Cases', sep = "")
               )

fig <- fig %>% layout(xaxis = list(title = '', 
                                   rangeselector = list(buttons = buttons_time)),
                      yaxis = list(title = 'Cumulative Case'), 
                      hovermode = "x unified", 
                      hoverlabel=list(bgcolor="black"), 
                      
                      paper_bgcolor='transparent')
fig 
```

### <b> The Curve - Logarithmic Scale </b>

```{r}
fig <- fig %>% layout(yaxis = list(type = "log"))
fig <- fig %>% layout(xaxis = list(title = ""),
                      yaxis = list (title = "Cumulative Case Counts (Log)"))
fig
```

### <b> Rolling Averages </b>

```{r}
#calculating rolling average 
dailyPHU %>% 
  dplyr::select(Accurate_Episode_Date, Cases) %>% 
  dplyr::mutate(MAV7 = round(zoo::rollmean(Cases, k = 7, fill = NA),0),
                MAV15 = round(zoo::rollmean(Cases, k = 15, fill = NA),0), 
                MAV29 = round(zoo::rollmean(Cases, k = 29, fill = NA),0)) %>% 
  data.frame() %>% 
plot_ly(x = ~Accurate_Episode_Date, 
        y = ~MAV7, 
        name = "7 Day Average",
        type = 'scatter', 
        mode = 'lines', 
        fill = 'tozeroy', 
        fillcolor = 'rgba(255, 89, 89, 0.7)',
        opacity = 0.25, 
        line = list(width = 0.1, color = 'rgba(255, 89, 89, 0.7)')) %>% 
  
  add_trace(y = ~MAV15, 
            name = "15 Day Average", 
            fillcolor = 'rgba(255, 197, 108, 0.7)',
            opacity = 0.25, 
            line = list(color = 'rgba(255, 197, 108, 0.7)')) %>% 
  
  add_trace(y = ~MAV29, 
            name = "29 Day Average",
            fillcolor = 'rgba(110, 197, 233, 0.7)',
            opacity = 0.25,
            line = list(color = 'rgba(110, 197, 233, 0.7)')) %>% 
  
  layout(title = "",
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "New Cases"), 
         hovermode = "x unified", 
         hoverlabel=list(bgcolor="black", bordercolor = "white"), 
         legend=list(title=list(text='<b> Moving Averages: </b>')))
```

### <b> Rolling Median </b>

```{r}


dailyPHU %>% 
  dplyr::select(Accurate_Episode_Date, Cases) %>% 
  dplyr::mutate(Rm7 = round(zoo::rollmean(Cases, k = 7, fill = NA),0),
                Rm15 = round(zoo::rollmean(Cases, k = 15, fill = NA),0), 
                Rm29 = round(zoo::rollmean(Cases, k = 29, fill = NA),0)) %>% 
  data.frame() %>% 
  
  plot_ly(x = ~Accurate_Episode_Date, 
          y = ~Rm7, 
          name = "7 Day Trend",
          type = 'scatter', 
          mode = 'lines', 
          fill = 'tozeroy', 
          fillcolor = 'rgba(255, 89, 89, 0.7)',
          opacity = 0.25, 
          line = list(width = 0.1, color = 'rgba(255, 89, 89, 0.7)')) %>% 
  
  add_trace(y = ~Rm15, 
            name = "15 Day Trend", 
            fillcolor = 'rgba(255, 197, 108, 0.7)',
            opacity = 0.25, 
            line = list(width = 0.1, color = 'rgba(255, 197, 108, 0.7)')) %>% 
  
  add_trace(y = ~Rm29, 
            name = "29 Day Trend", 
            fillcolor = 'rgba(110, 197, 233, 0.7)',
            opacity = 0.25, 
            line = list(width = 0.1, color = 'rgba(110, 197, 233, 0.7)')) %>% 
  
  layout(title = "",
         xaxis = list(title = " ", rangeselector = list(
           buttons = buttons_time)), 
         yaxis = list(title = "New Cases"), 
         hovermode = "x unified", 
         legend=list(title=list(text='<b> Rolling Medians </b>'))) 
```

Outcomes 
=====================================

```{r}
outcomes <- TargetPHU %>% 
  dplyr::select(Row_ID,Accurate_Episode_Date, Outcome1) %>% 
  group_by(Accurate_Episode_Date, Outcome1) %>% 
  summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  spread(Outcome1, count, fill = 0) %>% 
  as.data.frame()

outcomes <- outcomes %>% 
  #rename third column to unresolved
  dplyr::rename(Active = 3)
```


Row
-----------------------------------------------------------------------
### Current Active Cases 

```{r}
valueBox(format(round(as.numeric(sum(outcomes$Active)), 0), nsmall=0, big.mark=","), icon = "ion-android-person-add")
```

### Total Resolved 

```{r}
valueBox(format(round(as.numeric(sum(outcomes$Resolved)), 0), nsmall=0, big.mark=","), icon = "ion-android-person-add")
```

### Current Recovery Rate 

```{r}
rr <- paste(round(100-(sum(outcomes$Fatal)/sum(outcomes$Resolved, outcomes$Active, outcomes$Fatal) * 100),0), "%")
valueBox(rr, icon = "ion-ios-calculator")
```

### Total Deaths 
```{r}
valueBox(format(round(as.numeric(sum(outcomes$Fatal)), 0), nsmall=0, big.mark=","), icon = "ion-android-person-add")
```

### Death Rate per 100K Population 
```{r}
fatality <- sum(outcomes$Fatal/POP)
fatality_rate_per_capita_K <- as.integer(fatality*100000)

valueBox(fatality_rate_per_capita_K, icon = "ion-stats-bars")
```

### Recovery Rate per 100K Population 
```{r}
recovered <- sum(outcomes$Resolved/POP)
r_rate_per_capita_K <- as.integer(recovered*100000)

valueBox(format(r_rate_per_capita_K, big.mark = ","), icon = "ion-stats-bars")
```

Row {.tabset .tabset-fade}
-------------------------------------
### <b> Outcome Breakdown </b> 
```{r}
TargetPHU %>% 
  dplyr::group_by(Outcome1) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>%
  dplyr::ungroup() %>% 
  dplyr::rename(Outcome = Outcome1) %>% 
  dplyr::mutate(Outcome = case_when(
    .$Outcome == "Not Resolved" ~ "Active", 
    TRUE ~ as.character(Outcome))) %>% 
  data.frame() %>% 

plot_ly(labels = ~Outcome, values = ~n, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        
        text = ~paste(format(n, big.mark = ","), Outcome,
                      sep = " "),
        hoverinfo = 'text',
        
        marker = list(colors = c('#FF5959', "#FFC56C", "#6EC5E9"),
                      line = list(color = '#FFFFFF', width = 1)),
        showlegend = FALSE) %>% 
  
  layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```


### <b> Daily Outcomes </b> 
```{r}
#Cases by Outcome 
plot_ly(data = outcomes,
        x = ~Accurate_Episode_Date, y = ~Active, type = 'bar', name = 'Active', 
               marker = list(color = '#FFC56C'))%>% 
  
  add_trace(y = ~Resolved, name = 'Resolved', 
                         marker = list(color = '#6EC5E9')) %>% 
  
  add_trace(y = ~Fatal, name = 'Deaths', 
                         marker = list(color ='#FF5959')) %>% 
  
  layout(title = "", 
         xaxis = list(title = '', rangeselector = list(buttons = buttons_time)),
         yaxis = list(title = 'Daily Outcomes (n)'),
         hovermode = "x unified",
         barmode = 'stack', 
         legend=list(title=list(text='<b> Outcome: </b>')))
```

### <b> Daily Absolute Change </b>
```{r}
TargetPHU %>% 
  dplyr::select(Row_ID,Accurate_Episode_Date, Outcome1) %>% 
  dplyr::group_by(Accurate_Episode_Date, Outcome1) %>% 
  dplyr::summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  tidyr::spread(Outcome1, count, fill = 0) %>% 
  as.data.frame() %>% 
  dplyr::select(Accurate_Episode_Date, Fatal, Resolved) %>% 
  dplyr::mutate(d_diff = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date, n = 1)),
                new_deaths = Fatal - lag(Fatal, n = 1), 
                new_resolved = Resolved - lag(Resolved, n = 1))  %>% 


plot_ly(x = ~Accurate_Episode_Date, 
        y = ~new_resolved, 
        type = 'scatter',
        mode = "lines", 
        name = "Resolved", 
        line = list(color = "#6EC5E9", width = 1), 
        text = ~paste("Change in Resolves from Yesterday: ", new_resolved ,sep = ""),
        hoverinfo = "text") %>% 
  
  add_trace(y = ~new_deaths, 
            name = "Deaths", 
            line = list(color = "#FF5959", width = 1), 
            text = ~paste("Change in Deaths from Yesterday: ", new_deaths ,sep = ""),
            hoverinfo = "text") %>% 
  layout(title = "", 
         xaxis = list(title = '', rangeselector = list(buttons = buttons_time)),
         yaxis = list(title = 'Absolute Change (n)', 
                      dtick = 25, 
                      tick0 = 0, 
                      tickmode = "linear"), 
         hovermode = "x unified",
         barmode = 'stack', 
         legend=list(title=list(text='<b> Daily Outcomes: </b>'))) 

```


### <b> Daily Outcomes Composition </b> 

```{r}
#daily outcome composition 
outcomes %>% 
  dplyr::mutate(Total=Reduce("+",.[2:4])) %>% 
  dplyr::mutate(F_pct = round((Fatal/Total)*100,1), 
                A_pct = round((Active/Total)*100,1), 
                R_pct = round((Resolved/Total)*100,1)) %>% 
  
  plot_ly(x = ~Accurate_Episode_Date, 
          y = ~F_pct, 
          name = "Fatal",
          type = 'bar', 
          text = ~paste(Accurate_Episode_Date, "<br>",F_pct, " % Fatal (n = ", Fatal, ")",sep = ""), 
          hoverinfo = "text", 
          marker = list(color = '#FF5959')) %>% 
  
  add_trace(y = ~R_pct, 
            type = 'bar', 
            name = "Resolved", 
            text = ~paste(Accurate_Episode_Date, "<br>",R_pct, " % Resolved (n = ", Resolved , ")", sep = ""), 
            hoverinfo = "text", 
            marker = list(color = '#6EC5E9')) %>% 
  
  add_trace(y = ~A_pct, 
            type = 'bar', 
            name = "Active", 
            text = ~paste(Accurate_Episode_Date, "<br>",A_pct, " % Active (n = ", Active, ")", sep = ""), 
            hoverinfo = "text", 
            marker = list(color = '#FFC56C')) %>% 
  
  
  layout(title = "",
         xaxis = list(title = "",  
                      rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Frequency (%)",
                      dtick = 25, 
                      tick0 = 0.00, 
                      tickmode = "linear"), 
         barmode = 'stack',
         hovermode = "y-unified", 
         hoverlabel=list(bgcolor="black"),
         legend = list(title = list(text = '<b> Outcome: </b>')))  
```

### <b> Cumulative Outcomes </b> 

```{r}
TargetPHU %>% 
  dplyr::select(Row_ID,Accurate_Episode_Date, Outcome1) %>% 
  dplyr::filter(!Accurate_Episode_Date == "2019-12-25") %>% 
  group_by(Accurate_Episode_Date, Outcome1) %>% 
  summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  spread(Outcome1, count, fill = 0) %>% 
  as.data.frame() %>% 
  #rename third column to unresolved
  dplyr::rename(Active = 3) %>% 
  dplyr::select(-Active) %>% 
  dplyr::mutate(d_diff = as.numeric(Accurate_Episode_Date - lag(Accurate_Episode_Date)),
                total_deaths = cumsum(Fatal), 
                total_resolved = cumsum(Resolved)) %>% 
  dplyr::select(-Fatal, - Resolved ) %>% 
  
  plot_ly(x = ~Accurate_Episode_Date, 
          y = ~total_resolved, 
          type = 'bar', 
          name = 'Resolved', 
          marker = list(color = '#6EC5E9'),
          text = ~paste(Accurate_Episode_Date, "<br>",
                        format(total_resolved, big.mark = ","), " Total Resolved", sep = ""), 
          hoverinfo = "text") %>% 
  
  add_trace(y = ~total_deaths, 
            name = 'Deaths', 
            marker = list(color ='#FF5959'),
            text = ~paste(Accurate_Episode_Date, "<br>",
                          format(total_deaths, big.mark = ","), " Total Deaths", sep = ""), 
            hoverinfo = "text") %>% 
  
  layout(title = "", 
         xaxis = list(title = '', rangeselector = list(
                        buttons = buttons_time)),
         
         yaxis = list(title = 'Cumulative (Log)', type = "log"), 
         hovermode = "x unified",
         barmode = 'stack', 
         legend=list(title=list(text='<b> Cumulative Outcomes </b>'))) 
```





Case Acquisition
=====================================

```{r}
acqBreakdown <- TargetPHU %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  dplyr::group_by(Case_AcquisitionInfo) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame()

acqBreakdown$colors <- c("#E01E5A", "#F4B400", "#25D366", "#C0C0C0")
```


Row
-----------------------------------------------------------------------

### Travel Related Cases 
```{r}
TRC <- round(sum(TargetPHU$Case_AcquisitionInfo == "Travel")/nrow(TargetPHU)*100, 1)
valueBox(paste(TRC, "%"), icon = "ion-plane")
```

### Close Contact Cases 
```{r}
CCC <- round(sum(TargetPHU$Case_AcquisitionInfo == "CC")/nrow(TargetPHU)*100, 1)
valueBox(paste(CCC, "%"), icon = "ion-ios-people")
```

### Outbreak Related Cases 
```{r}
ORC <- round(sum(TargetPHU$Case_AcquisitionInfo == "OB")/nrow(TargetPHU)*100, 1)
valueBox(paste(ORC, "%"), icon = "ion-alert-circled")
```

### Unknown Cases
```{r}
valueBox(paste(100-sum(TRC, ORC, CCC), "%"), icon = "ion-help")
```

Row {.tabset .tabset-fade}
-------------------------------------

### <b> Breakdown </b> 
```{r}
TargetPHU %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  dplyr::group_by(Case_AcquisitionInfo) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 


plot_ly(labels = ~Case_AcquisitionInfo, 
        values = ~n, 
        type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        text = ~paste(Case_AcquisitionInfo, '<br>', 
                      format(n, nsmall = 0, big.mark = ","), ' cases', sep = ""),
        hoverinfo = 'text',
        
        marker = list(colors = c("#E01E5A", "#F4B400", "#25D366", "#C0C0C0"),
                      line = list(color = '#FFFFFF', width = 1)),
               showlegend = FALSE) %>% 
  
  layout(xaxis = list(showgrid = FALSE, 
                      zeroline = FALSE, 
                      showticklabels = FALSE),
         
         yaxis = list(showgrid = FALSE, 
                      zeroline = FALSE, 
                      showticklabels = FALSE))
``` 

### <b> Daily Acquisitions </b> 

```{r}
TargetPHU %>% 
  dplyr::select(Row_ID, Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>%
  group_by(Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  summarise(count = n(), .groups = 'keep') %>%
  dplyr::ungroup() %>% 
  spread(Case_AcquisitionInfo, count, fill = 0) %>% 
  as.data.frame() %>% 

plot_ly(x = ~Accurate_Episode_Date, 
        y = ~`Close Contact`, type = 'bar', 
        name = 'Close Contact', 
        marker = list(color = '#E01E5A')) %>% 
  
  add_trace(y = ~`Outbreak Related`, name = 'Outbreak Related', marker = list(color = '#F4B400')) %>% 
  
  add_trace(y = ~Travel, name = 'Travel', marker = list(color ='#25D366'))%>% 
  
  add_trace(y = ~Unknown, 
            name = "Unknown", marker = list(color = "#DCDCDC")) %>% 
  
  layout(title = "", 
         xaxis = list(title = '', 
                      rangeselector = list(buttons = buttons_time)),
         yaxis = list(title = 'Frequency (n)'), 
         hovermode = "x unified",
         barmode = 'stack',
         legend=list(title=list(text='<b> Case Acquisition Type: </b>'))) 
```

### <b> Acquisitions Composition </b> 

```{r}
TargetPHU %>% 
  dplyr::select(Row_ID, Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>%
  group_by(Accurate_Episode_Date, Case_AcquisitionInfo) %>% 
  summarise(count = n(), .groups = 'keep') %>%
  dplyr::ungroup() %>% 
  spread(Case_AcquisitionInfo, count, fill = 0) %>% 
  as.data.frame()  %>% 
  #computes Rowise sums for column via index 
  dplyr::mutate(Total=Reduce("+",.[2:5])) %>% 
  #compute frquency (%) 
  dplyr::mutate(cc_Pct = round((`Close Contact` / Total)*100,1), 
                ob_Pct = round((`Outbreak Related` / Total)*100,1),
                TR_Pct = round((Travel / Total)*100,1),
                unkn_pct = round((Unknown / Total)*100,1)) %>% 
  #dplyr::select(Accurate_Episode_Date, cc_Pct, ob_Pct, TR_Pct, unkn_pct) %>% 
plot_ly(x = ~Accurate_Episode_Date, 
          y = ~cc_Pct, 
          name = "Close Contact",
          type = 'bar', 
          text = ~paste(Accurate_Episode_Date, "<br>",cc_Pct, " % Close Contact (n = ", `Close Contact`, ")",sep = ""), 
          hoverinfo = "text", 
          marker = list(color = '#FF5959')) %>% 
  
  add_trace(y = ~unkn_pct, 
            type = 'bar', 
            name = "Unknown", 
            text = ~paste(Accurate_Episode_Date, "<br>",unkn_pct, " % Unknown (n = ", Unknown , ")", sep = ""), 
            hoverinfo = "text", 
            marker = list(color = '#DCDCDC')) %>% 
  
  add_trace(y = ~ob_Pct, 
            type = 'bar', 
            name = "Outbreak", 
            text = ~paste(Accurate_Episode_Date, "<br>",ob_Pct, " % Outbreak (n = ", `Outbreak Related`, ")", sep = ""), 
            hoverinfo = "text", 
            marker = list(color = '#F4B400')) %>% 
  
  add_trace(y = ~TR_Pct, 
            type = 'bar', 
            name = "Travel", 
            text = ~paste(Accurate_Episode_Date, "<br>",TR_Pct, " % Travel (n = ", Travel, ")", sep = ""), 
            hoverinfo = "text", 
            marker = list(color = '#25D366')) %>% 
  
  
  layout(title = "",
         xaxis = list(title = "",  
                      rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Acquistion Frequency (%)",
                      dtick = 25, 
                      tick0 = 0.00, 
                      tickmode = "linear"), 
         barmode = 'stack',
         hovermode = "y-unified", 
         hoverlabel=list(bgcolor="black"),
         legend = list(title = list(text = '<b> Case Acquisition Type: </b>')))   
```


### <b> Cumulative Acquisitions (Linear) </b> 
```{r cumacq}
TargetPHU %>% 
  dplyr::select(Row_ID,Case_Reported_Date, Case_AcquisitionInfo) %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  dplyr::group_by(Case_Reported_Date, Case_AcquisitionInfo) %>% 
  dplyr::summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  tidyr::spread(Case_AcquisitionInfo, count, fill = 0) %>% 
  as.data.frame() %>% 
  
  #adding cumulative counts 
  dplyr::mutate(CC_csum = cumsum(`Close Contact`), 
                OB_csum = cumsum(`Outbreak Related`), 
                Travel_csum = cumsum(Travel),
                Unknown_csum = cumsum(`Unknown`)) %>% 
  tidyr::drop_na(Case_Reported_Date) %>% 

#acq_daily <- na.omit(acq_daily, cols = "Case_Reported_Date")

plot_ly(x = ~Case_Reported_Date, 
        y = ~CC_csum, 
        type = 'scatter', mode = 'none', fill = 'tozeroy', 
        name = 'Close Contact', 
        fillcolor = 'rgba(224, 30, 90, 0.7)',
        opacity = 0.8) %>% 
  
  add_trace(y = ~Unknown_csum, 
            name = "Uknown", 
            fill = 'tozeroy',
            fillcolor = 'rgba(220, 220, 220, 0.7)',
            opacity = 0.8) %>% 
  
  add_trace(y = ~OB_csum, 
            name = "Outbreak", 
            fill = 'tozeroy',
            fillcolor = 'rgba(244, 180, 0, 0.7)',
            opacity = 0.8) %>% 
  
  add_trace(y = ~Travel_csum, 
            name = "Travel", 
            fill = 'tozeroy',
            fillcolor = 'rgba(37, 211, 102, 0.7)',
            opacity = 0.8) %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Cumulative Totals"),
         legend=list(title=list(text='<b> Case Acquisition Type: </b>')))
```

### <b> Cumulative Acquisitions (Log) </b>
```{r}
TargetPHU %>% 
  dplyr::select(Row_ID,Case_Reported_Date, Case_AcquisitionInfo) %>% 
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  dplyr::group_by(Case_Reported_Date, Case_AcquisitionInfo) %>% 
  dplyr::summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  tidyr::spread(Case_AcquisitionInfo, count, fill = 0) %>% 
  as.data.frame() %>% 
  
  #adding cumulative counts 
  dplyr::mutate(CC_csum = cumsum(`Close Contact`), 
                OB_csum = cumsum(`Outbreak Related`), 
                Travel_csum = cumsum(Travel),
                Unknown_csum = cumsum(`Unknown`)) %>% 
  tidyr::drop_na(Case_Reported_Date) %>% 

#acq_daily <- na.omit(acq_daily, cols = "Case_Reported_Date")

plot_ly(x = ~Case_Reported_Date, 
        y = ~CC_csum, 
        type = 'scatter', mode = 'none', fill = 'tozeroy', 
        name = 'Close Contact', 
        fillcolor = 'rgba(224, 30, 90, 0.7)',
        opacity = 0.8) %>% 
  
  add_trace(y = ~Unknown_csum, 
            name = "Uknown", 
            fill = 'tozeroy',
            fillcolor = 'rgba(220, 220, 220, 0.7)',
            opacity = 0.8) %>% 
  
  add_trace(y = ~OB_csum, 
            name = "Outbreak", 
            fill = 'tozeroy',
            fillcolor = 'rgba(244, 180, 0, 0.7)',
            opacity = 0.8) %>% 
  
  add_trace(y = ~Travel_csum, 
            name = "Travel", 
            fill = 'tozeroy',
            fillcolor = 'rgba(37, 211, 102, 0.7)',
            opacity = 0.8) %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Cumulative Totals (Log)", type = "log"),
         legend=list(title=list(text='<b> Case Acquisition Type: </b>')))
```

### <b> Heatmaps </b> 

```{r}
TargetPHU %>% 
  dplyr::select(Row_ID, Accurate_Episode_Date, 
                Case_AcquisitionInfo) %>% 
  
  dplyr::mutate(Case_AcquisitionInfo = case_when(
    .$Case_AcquisitionInfo == "OB" ~ "Outbreak Related", 
    .$Case_AcquisitionInfo == "CC" ~ "Close Contact",
    .$Case_AcquisitionInfo == "Travel" ~ "Travel",
    .$Case_AcquisitionInfo == "No known epi link" ~ "Unknown",
    .$Case_AcquisitionInfo == "Missing Information" ~ "Unknown",
    .$Case_AcquisitionInfo == "Unspecified epi link" ~ "Unknown")) %>% 
  
  dplyr::group_by(Accurate_Episode_Date, 
                  Case_AcquisitionInfo) %>% 
  
  dplyr::summarise(count = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 
  
  dplyr::mutate(Case_AcquisitionInfo = factor(Case_AcquisitionInfo, 
                                              levels = unique(Case_AcquisitionInfo)[order(count,decreasing = F)]))  %>% 

plot_ly(x = ~Accurate_Episode_Date, 
        y = ~Case_AcquisitionInfo, 
        z = ~count, 
        type = "heatmap",
        #colors = colorRamp(c("Black","Blue", "Red")),
        text = ~paste("<b>", Case_AcquisitionInfo, "</b>", "<br>",
                      Accurate_Episode_Date,  
                      "<br>", count, " cases",
                      sep = ""), 
        hoverinfo = "text", 
        
        showlegend = F, 
        showscale = T, 
        colorbar = list(title = "Case Count:")) %>% 
  
  layout(title = "", 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)),
         yaxis = list(title = ""),
         barmode = 'stack', 
         hovermode = 'x-unified', 
         hoverlabel=list(bgcolor="black"), 
         plot_bgcolor='Black',
         paper_bgcolor='Black', 
         font = list(color = 'Grey')) 
```


Demographics
=====================================

Row {.tabset .tabset-fade}
-------------------------------------

### <b> Age Breakdown Pie </b> 
```{r}
TargetPHU %>% 
  dplyr::group_by(Age_Group) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 

plot_ly(labels = ~Age_Group, 
        values = ~n, 
        type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        hoverinfo = 'text',
        text = ~paste("Age Group: ", Age_Group, "<br>", 
                      format(n, big.mark = ","), ' Cases', 
                      sep = " "),
        
        marker = list(colors = ~colors,
                      line = list(color = '#FFFFFF', width = 1)),
        showlegend = FALSE) %>% 
  
  layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

### <b> Age Breakdown Treemap </b> 
```{r}
TargetPHU %>% 
  dplyr::group_by(Age_Group) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 

  plot_ly(labels = ~Age_Group, 
          parents = NA, 
          values = ~n, 
          type = 'treemap', 
          domain = list(column=0), 
          marker = list(colorscale = 'Rainbow', reversescale = T),
          textposition = 'inside',
          textinfo = 'label',
          insidetextfont = list(color = '#FFFFFF', size = 20),
          hoverinfo = 'text',
          text = ~paste(Age_Group,':', format(n, big.mark = ","), 'Total Cases')) %>% 
  
  layout(plot_bgcolor = 'black', 
         paper_bgcolor = 'black', 
         grid = list(columns = 1, rows = 1))
```

### <b> Daily Cases by Age </b>

```{r}
TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::filter(!Accurate_Episode_Date == "2019-12-25") %>% 
  dplyr::group_by(Accurate_Episode_Date, Age_Group) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 
  dplyr::mutate(Age_Group = ordered(Age_Group, levels = c("<20", "20s", "30s", "40s", "50s", "60s", "70s", "80s", "90s"))) %>% 
  dplyr::arrange(Accurate_Episode_Date, Age_Group) %>% 

plot_ly(x = ~Accurate_Episode_Date, 
        y = ~n, 
        type = 'bar', 
        color = ~Age_Group, 
        colors = "Paired", 
        text = ~paste(Accurate_Episode_Date, "<br>",
                      "Age Group: ", Age_Group, "<br>",
                      format(n, big.mark = ","), " Cases", sep = ""), 
        hoverinfo = "text") %>% 
  
  layout(barmode = "stack", 
         hovermode = 'x-unified', 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Cases (n)"), 
         legend=list(title=list(text='<b> Age Group </b>'))) 
```

### <b> Overall Cases by Age Group (Linear) </b>
```{r csumbyAge}

TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::filter(!Accurate_Episode_Date == "2019-12-25") %>% 
  dplyr::group_by(Accurate_Episode_Date, Age_Group) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 
  dplyr::mutate(Age_Group = ordered(Age_Group, levels = c("<20", "20s", "30s", "40s", "50s", "60s", "70s", "80s", "90s"))) %>% 
  dplyr::arrange(Accurate_Episode_Date, Age_Group) %>% 
  dplyr::group_by(Age_Group) %>%
  dplyr::mutate(csum = cumsum(n)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(Accurate_Episode_Date, Age_Group, csum) %>% 
  data.frame() %>% 

plot_ly(x = ~Accurate_Episode_Date, y = ~csum, 
        type = 'scatter', mode = 'lines', fill = 'tozeroy', 
        color = ~Age_Group, 
        colors = "Paired", 
        text = ~paste(Accurate_Episode_Date, "<br>",
                      "Age Group: ", Age_Group, "<br>",
                      format(csum, big.mark = ","), " Total Cases to Date", sep = ""), 
        hoverinfo = "text") %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Cases"), 
         legend=list(title=list(text='<b> Age Group </b>')))
```

### <b> Overall Cases by Age Group </b>

```{r csumbyAgeLog}
TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::filter(!Accurate_Episode_Date == "2019-12-25") %>% 
  dplyr::group_by(Accurate_Episode_Date, Age_Group) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 
  dplyr::mutate(Age_Group = ordered(Age_Group, levels = c("<20", "20s", "30s", "40s", "50s", "60s", "70s", "80s", "90s"))) %>% 
  dplyr::arrange(Accurate_Episode_Date, Age_Group) %>% 
  dplyr::group_by(Age_Group) %>%
  dplyr::mutate(csum = cumsum(n)) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(Accurate_Episode_Date, Age_Group, csum) %>% 
  data.frame() %>% 

plot_ly(x = ~Accurate_Episode_Date, y = ~csum, 
        type = 'scatter', mode = 'lines', fill = 'tozeroy', 
        color = ~Age_Group, 
        colors = "Paired", 
        text = ~paste(Accurate_Episode_Date, "<br>",
                      "Age Group: ", Age_Group, "<br>",
                      format(csum, big.mark = ","), " Total Cases to Date", sep = ""), 
        hoverinfo = "text") %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = "", rangeselector = list(buttons = buttons_time)), 
         yaxis = list(title = "Cumulative Cases (Log)", type = "log"), 
         legend=list(title=list(text='<b> Age Group: </b>')))
```

### <b> Gender Breakdown </b>
```{r}
#breakdown by gender 
TargetPHU %>%
  dplyr::filter(Client_Gender == "FEMALE" | Client_Gender == "MALE") %>% 
  dplyr::group_by(Client_Gender) %>% 
  dplyr::summarise(n = n(), .groups = 'keep') %>% 
  dplyr::ungroup() %>% 
  data.frame() %>% 

plot_ly(labels = ~Client_Gender, values = ~n, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'),
        text = ~paste(format(n, nsmall = 0, big.mark = ","),' Total Cases'),
        hoverinfo = 'text',
        
        marker = list(colors = c('#c37ef0', "#54c3ff"),
                      line = list(color = '#FFFFFF', width = 1)),
        showlegend = FALSE) %>% 
  
  layout(xaxis = list(showgrid = FALSE, 
                      zeroline = FALSE, 
                      showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

### <b> Daily Cases by Gender </b>
```{r}
TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::filter(Client_Gender == "FEMALE" | Client_Gender == "MALE") %>% 
  dplyr::group_by(Accurate_Episode_Date, Client_Gender) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(HEX = case_when(Client_Gender == "MALE" ~ '#54c3ff', 
                                Client_Gender == "FEMALE" ~ '#c37ef0')) %>%
  dplyr::mutate(HEX = as.character(HEX)) %>% 
  dplyr::arrange(desc(Accurate_Episode_Date)) %>% 
  data.frame() %>% 

plot_ly(x = ~Accurate_Episode_Date, 
        y = ~n, 
        type = 'bar', 
        color = ~Client_Gender, 
        colors = ~HEX) %>% 
  
  layout(barmode = "stack", 
         hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "New Cases")) 

```

### <b> Overall Cases by Gender (Linear) </b> 
```{r}
daily_genders_cum <- TargetPHU %>% 
  dplyr::filter(!is.na(Accurate_Episode_Date)) %>% 
  dplyr::filter(Client_Gender == "FEMALE" | Client_Gender == "MALE") %>% 
  dplyr::group_by(Accurate_Episode_Date, Client_Gender) %>% 
  dplyr::count(name = "n") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(HEX = case_when(Client_Gender == "MALE" ~ '#54c3ff', 
                                Client_Gender == "FEMALE" ~ '#c37ef0')) %>%
  dplyr::mutate(HEX = as.character(HEX)) %>% 
  dplyr::arrange(desc(Accurate_Episode_Date)) %>% 
  data.frame() %>% 
  dplyr::filter(!Accurate_Episode_Date == "2019-12-25") %>% 
  dplyr::arrange(Accurate_Episode_Date)%>% 
  dplyr::group_by(Client_Gender) %>% 
  dplyr::mutate(Total = cumsum(n)) %>% 
  dplyr::mutate(HEX = as.character(HEX)) %>%
  dplyr::ungroup() %>% 
  data.frame()

males <- daily_genders_cum[which(daily_genders_cum$Client_Gender == "MALE"), ]
females <- daily_genders_cum[which(daily_genders_cum$Client_Gender == "FEMALE"), ]

plot_ly(females, x = ~Accurate_Episode_Date,  y = ~Total,  type = 'scatter', mode = 'none', name = 'FEMALE', fill = 'tozeroy', 
        fillcolor = 'rgba(195, 126, 240, 0.7)') %>% 
  
  
  add_trace(data = males, x = ~Accurate_Episode_Date, y = ~Total, name = "MALE",
            fillcolor = 'rgba(84, 195, 255, 0.7)') %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "Total Cases")) %>% 
  
  layout(xaxis = list(rangeselector = list(
    buttons = buttons_time)))
```

### <b> Overall Cases by Gender (Log) </b> 

```{r}
plot_ly(females, x = ~Accurate_Episode_Date,  y = ~Total,  type = 'scatter', mode = 'none', name = 'FEMALE', fill = 'tozeroy', 
        fillcolor = 'rgba(195, 126, 240, 0.7)') %>% 
  
  
  add_trace(data = males, x = ~Accurate_Episode_Date, y = ~Total, name = "MALE",
            fillcolor = 'rgba(84, 195, 255, 0.7)') %>% 
  
  layout(hovermode = 'x-unified', 
         xaxis = list(title = ""), 
         yaxis = list(title = "Total Cases (Log)", type = "log")) %>% 
  
  layout(xaxis = list(rangeselector = list(
    buttons = buttons_time)))
```


About this Site
===================================== 

#### <b> Last Update: `r paste(format(Sys.time(), "%Y-%m-%d"))` </b>   

</br>

#### <b> Background </b>
*"Nothing in life is to be feared, it is only to be understood. Now is the time to understand more, so that we may fear less" - Marie Curie*  

#### <b> Code </b>
Codebase and dataset used to generate this web application are available on [Github](https://github.com/Erebus54/YorkRegion-Covid19-Tracker-Dashboard).


#### <b> Sources </b> 

**Status of COVID-19 cases in Ontario** : [Open Data Ontario](https://data.ontario.ca/en/dataset/confirmed-positive-cases-of-covid-19-in-ontario), updated daily, which presents a breakdown by region, case status, age range of cases 

#### <b> Author </b> 

Patrick Schnurbusch

#### <b> Contact </b> 

patrick.schnurbusch@gmail.com
